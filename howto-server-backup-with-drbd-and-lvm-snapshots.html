<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Server Backup with DRBD (and LVM + Snapshots) &mdash; wiki'd</title>
  <meta name="author" content="JoKeru">






  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


    <link href="./favicon.png" rel="icon">

  <link href="./theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">

  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="./">wiki'd</a></h1>
    <h2>by JoKeru</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>

<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value=".">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<ul class="main-navigation">
      <li class="active">
        <a href="./category/howto.html">Howto</a>
      </li>
      <li >
        <a href="./category/privacy.html">Privacy</a>
      </li>
      <li >
        <a href="./category/sysadmin.html">Sysadmin</a>
      </li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">Server Backup with DRBD (and LVM + Snapshots)</h1>
    <p class="meta">
<time datetime="2014-05-26T23:23:00+01:00" pubdate>Mon 26 May 2014</time>    </p>
</header>

  <div class="entry-content"><p><a href="http://www.drbd.org/" title="http://www.drbd.org/">Distributed Replicated Block Device
(DRBD)</a> mirrors block
devices between multiple hosts via an assigned network to form high
availability clusters. The replication is transparent to other
applications on the host systems. Any block device hard disks,
partitions, RAID devices, logical volumes, etc can be mirrored. DRBD can
be understood as network based raid-1.</p>
<p>DRBD can also be used as a backup solution over network or data disaster
recovery solution. In our setup we'll be using the following layers:<br />
[cc lang='bash']  </p>
<hr />
<h2>| physical disk |</h2>
<h2>| lvm |</h2>
<h2>| drbd |</h2>
<h2>| ext4 |</h2>
<p>[/cc]<br />
The second layer is LVM because on the backup server you cannot access
the data directly (DRBD will not allow to mount the /dev/drbd0 volume,
itâ€™s locked to the drbd0 process). But snapshots allow us to subvert the
lock a bit. Or at least give us read access to the existing data.</p>
<p>[cc lang='bash']<br />
# node01 is the main server<br />
# /dev/sdb is the disk containing important data, 16g size<br />
\$ apt-get install drbd8-utils lvm2<br />
\$ fdisk /dev/sdb # create 1 primary lvm partition (type 8e), 16g
size<br />
\$ pvcreate /dev/sdb1<br />
\$ vgcreate vg0 /dev/sdb1<br />
\$ lvcreate -l 100%FREE -n lv0 vg0<br />
\$ lvdisplay | grep "Current LE" # this value will be used on node02
setup<br />
Current LE 4095<br />
[/cc]</p>
<p>[cc lang='bash']<br />
# node02 is the backup server<br />
# /dev/sdb is the disk storing the backup data, 32g size<br />
\$ apt-get install drbd8-utils lvm2<br />
\$ fdisk /dev/sdb # create 1 primary lvm partition (type 8e), 32g
size<br />
\$ pvcreate /dev/sdb1<br />
\$ vgcreate vg0 /dev/sdb1<br />
\$ lvcreate -l 4095 -n lv0 vg0 # this is the "Current LE" value from
node01<br />
[/cc]</p>
<p>Configure and start DRBD on both servers:<br />
[cc lang='bash']<br />
# node01 &amp; node02<br />
\$ cat \&lt;\&lt;'EOF' > /etc/drbd.conf<br />
global { usage-count no; }<br />
common { syncer { rate 1000M; } }<br />
resource r0 {<br />
protocol C; # Synchronous replication protocol<br />
startup {<br />
wfc-timeout 15;<br />
degr-wfc-timeout 60;<br />
}<br />
net {<br />
cram-hmac-alg sha1;<br />
shared-secret "secret";<br />
}<br />
on node01 {<br />
device /dev/drbd0;<br />
disk /dev/vg0/lv0;<br />
address 10.20.30.40:7788;<br />
meta-disk internal;<br />
}<br />
on node02 {<br />
device /dev/drbd0;<br />
disk /dev/vg0/lv0;<br />
address 50.60.70.80:7788;<br />
meta-disk internal;<br />
}<br />
}<br />
EOF<br />
\$ drbdadm create-md r0<br />
\$ service drbd start<br />
[/cc]</p>
<p>Run this only on the main server to promote node01 as primary and start
syncing the data to node02:<br />
[cc lang='bash']<br />
# node01<br />
\$ drbdadm -- --overwrite-data-of-peer primary all<br />
\$ watch -n1 "cat /proc/drbd"<br />
# wait until the data is fully synced<br />
\$ mkfs.ext4 /dev/drbd0<br />
\$ mkdir /important<br />
\$ echo '/dev/drbd0 /important ext4 errors=remount-ro 0 1' >>
/etc/fstab<br />
\$ mount -a<br />
# let's add some content<br />
\$ cd /important/<br />
\$ dd if=/dev/zero of=zero.100 bs=1M count=100<br />
\$ md5sum zero.100<br />
2f282b84e7e608d5852449ed940bfc51 zero.100<br />
[/cc]</p>
<p>Now let's test if the data is actually syncing between the main and the
backup:<br />
[cc lang='bash']<br />
# node01<br />
\$ umount /important<br />
\$ drbdadm secondary r0 # demote the main server to the secondary role</p>
<p># node02<br />
\$ drbdadm primary r0 # promote the backup server to the primary role<br />
\$ mkdir /important<br />
\$ mount /dev/drbd0 /important<br />
\$ cd /important<br />
\$ ls<br />
lost+found zero.100<br />
\$ md5sum zero.100<br />
2f282b84e7e608d5852449ed940bfc51 zero.100 # same md5sum as main
server<br />
\$ service drbd status<br />
drbd driver loaded OK; device status:<br />
version: 8.3.7 (api:88/proto:86-91)<br />
srcversion: EE47D8BF18AC166BE219757<br />
m:res cs ro ds p mounted fstype<br />
0:r0 Connected Primary/Secondary UpToDate/UpToDate C /important ext4<br />
[/cc]</p>
<p>Let's switch back to the original scenario:<br />
[cc lang='bash']<br />
# node02<br />
\$ umount /important<br />
\$ drbdadm secondary r0</p>
<p># node01<br />
\$ drbdadm primary r0 # promote the backup server to the primary role<br />
\$ mount -a<br />
[/cc]</p>
<p>Now that everything is working as expected, let's take advantage of our
remote real-time backup system using LVM Snapshots:<br />
[cc lang='bash']<br />
# node02<br />
\$ lvcreate -L1G -s -n lv0-bkp01 /dev/vg0/lv0<br />
\$ mkdir /important-bkp01<br />
\$ mount -t ext4 /dev/vg0/lv0-bkp01 /important-bkp01/<br />
\$ cd /important-bkp01/<br />
\$ ls<br />
lost+found zero.100<br />
\$ md5sum zero.100<br />
2f282b84e7e608d5852449ed940bfc51 zero.100 # same md5sum as main
server<br />
[/cc]<br />
You can cron the creation / removal of snapshots according to your
needs (and your disk size) to provide either a back-in-time file
solution or a complete mirror access to the data on primary server.</p></div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">
        jokeru
    </span>
  </span>
<time datetime="2014-05-26T23:23:00+01:00" pubdate>Mon 26 May 2014</time>  <span class="categories">
    <a class='category' href='./category/howto.html'>HowTo</a>
  </span>
  <span class="categories">
    <a class="category" href="./tag/backup.html">backup</a>,    <a class="category" href="./tag/drbd.html">drbd</a>,    <a class="category" href="./tag/high-availability.html">High Availability</a>,    <a class="category" href="./tag/lvm.html">lvm</a>,    <a class="category" href="./tag/raid.html">RAID</a>,    <a class="category" href="./tag/snapshot.html">snapshot</a>  </span>
</p><div class="sharing">
</div>    </footer>
  </article>

</div>
<aside class="sidebar">
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="./how-to-it-s-time-to-drop-wordpress-say-hello-to-my-pelican.html">It's time to drop WordPress, say hello to my Pelican</a>
      </li>
      <li class="post">
          <a href="./google-dns-down-18-march-2016.html">Google DNS Down - 18 March 2016</a>
      </li>
      <li class="post">
          <a href="./how-to-couchbase-install-error-on-openvz.html">Couchbase install error on OpenVZ</a>
      </li>
      <li class="post">
          <a href="./how-to-stay-low-dns.html">Stay Low - DNS</a>
      </li>
      <li class="post">
          <a href="./how-to-ipmi-sol-on-debian.html">IPMI SOL on Debian</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="./category/howto.html">HowTo</a></li>
        <li><a href="./category/privacy.html">privacy</a></li>
        <li><a href="./category/sysadmin.html">sysadmin</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
    <a href="./tag/reverse-proxy.html">reverse proxy</a>,    <a href="./tag/restore.html">Restore</a>,    <a href="./tag/postfix.html">Postfix</a>,    <a href="./tag/sysctl.html">sysctl</a>,    <a href="./tag/brute-force.html">brute force</a>,    <a href="./tag/nosql.html">nosql</a>,    <a href="./tag/wmware.html">WMware</a>,    <a href="./tag/dba.html">dba</a>,    <a href="./tag/ping.html">ping</a>,    <a href="./tag/tcp.html">TCP</a>,    <a href="./tag/olive.html">Olive</a>,    <a href="./tag/bandwidth.html">bandwidth</a>,    <a href="./tag/iops.html">IOPS</a>,    <a href="./tag/strace.html">strace</a>,    <a href="./tag/hack.html">hack</a>,    <a href="./tag/disk.html">disk</a>,    <a href="./tag/retention.html">retention</a>,    <a href="./tag/web.html">web</a>,    <a href="./tag/ext4.html">ext4</a>,    <a href="./tag/load-balance.html">Load Balance</a>,    <a href="./tag/pptpd.html">pptpd</a>,    <a href="./tag/wget.html">wget</a>,    <a href="./tag/imap.html">IMAP</a>,    <a href="./tag/striping.html">striping</a>,    <a href="./tag/selinux.html">SELinux</a>,    <a href="./tag/softether.html">softether</a>,    <a href="./tag/pubsub.html">pub/sub</a>,    <a href="./tag/iptables.html">iptables</a>,    <a href="./tag/masterslave.html">master/slave</a>,    <a href="./tag/dk.html">DK</a>,    <a href="./tag/python.html">python</a>,    <a href="./tag/ipmi.html">ipmi</a>,    <a href="./tag/dd.html">dd</a>,    <a href="./tag/db.html">db</a>,    <a href="./tag/auth.html">auth</a>,    <a href="./tag/repo.html">repo</a>,    <a href="./tag/ssl.html">SSL</a>,    <a href="./tag/amazon.html">Amazon</a>,    <a href="./tag/traffic.html">traffic</a>,    <a href="./tag/ssh.html">SSH</a>,    <a href="./tag/tmpfs.html">tmpfs</a>,    <a href="./tag/transparent.html">transparent</a>,    <a href="./tag/ipsec.html">ipsec</a>,    <a href="./tag/webmail.html">Webmail</a>,    <a href="./tag/postgix.html">postgix</a>,    <a href="./tag/vsftpd.html">Vsftpd</a>,    <a href="./tag/couchbase.html">couchbase</a>,    <a href="./tag/gui.html">gui</a>,    <a href="./tag/dante.html">Dante</a>,    <a href="./tag/webmin.html">Webmin</a>,    <a href="./tag/token.html">token</a>,    <a href="./tag/session.html">session</a>,    <a href="./tag/nfs.html">NFS</a>,    <a href="./tag/ftpfs.html">ftpfs</a>,    <a href="./tag/rsync.html">rsync</a>,    <a href="./tag/debug.html">debug</a>,    <a href="./tag/x.html">x</a>,    <a href="./tag/security.html">security</a>,    <a href="./tag/mysql-proxy.html">mysql-proxy</a>,    <a href="./tag/freeradius.html">freeradius</a>,    <a href="./tag/virtualbox.html">VirtualBox</a>,    <a href="./tag/google.html">google</a>,    <a href="./tag/pure-ftpd.html">pure-ftpd</a>,    <a href="./tag/logs.html">logs</a>,    <a href="./tag/centos.html">CentOS</a>,    <a href="./tag/drbd.html">drbd</a>,    <a href="./tag/ipip.html">ipip</a>,    <a href="./tag/chunk.html">chunk</a>,    <a href="./tag/mysql.html">MySQL</a>,    <a href="./tag/kibana.html">kibana</a>,    <a href="./tag/cron.html">cron</a>,    <a href="./tag/hp-smart-array.html">HP Smart Array</a>,    <a href="./tag/mod_proxy_fcgi.html">mod_proxy_fcgi</a>,    <a href="./tag/radius.html">radius</a>,    <a href="./tag/backfire.html">backfire</a>,    <a href="./tag/ebs.html">EBS</a>,    <a href="./tag/iperf.html">iperf</a>,    <a href="./tag/mtu.html">MTU</a>,    <a href="./tag/ephemeral-ports.html">ephemeral ports</a>,    <a href="./tag/vmware.html">VMware</a>,    <a href="./tag/reverse-path-forwarding.html">Reverse Path Forwarding</a>,    <a href="./tag/ftp.html">FTP</a>,    <a href="./tag/centreon.html">Centreon</a>,    <a href="./tag/scale.html">scale</a>,    <a href="./tag/stats.html">stats</a>,    <a href="./tag/juniper.html">Juniper</a>,    <a href="./tag/redis.html">redis</a>,    <a href="./tag/grafana.html">grafana</a>,    <a href="./tag/routing.html">Routing</a>,    <a href="./tag/cciss.html">cciss</a>,    <a href="./tag/google-cloud-storage.html">Google Cloud Storage</a>,    <a href="./tag/opennicproject.html">opennicproject</a>,    <a href="./tag/vesta.html">vesta</a>,    <a href="./tag/elk.html">elk</a>,    <a href="./tag/inotify.html">inotify</a>,    <a href="./tag/vnc-server.html">vnc server</a>,    <a href="./tag/influxdb.html">influxdb</a>,    <a href="./tag/3proxy.html">3proxy</a>,    <a href="./tag/tcp_timestamp.html">tcp_timestamp</a>,    <a href="./tag/ubuntu.html">ubuntu</a>,    <a href="./tag/apache.html">apache</a>,    <a href="./tag/stripe-width.html">stripe-width</a>,    <a href="./tag/logstash.html">logstash</a>,    <a href="./tag/bash.html">bash</a>,    <a href="./tag/usb.html">usb</a>,    <a href="./tag/tls.html">TLS</a>,    <a href="./tag/socket.html">socket</a>,    <a href="./tag/license.html">license</a>,    <a href="./tag/undelete.html">undelete</a>,    <a href="./tag/ilo.html">ilo</a>,    <a href="./tag/ids.html">ids</a>,    <a href="./tag/stride.html">stride</a>,    <a href="./tag/configuration-management.html">configuration management</a>,    <a href="./tag/elasticsearch.html">elasticsearch</a>,    <a href="./tag/rdm.html">rdm</a>,    <a href="./tag/xfce.html">xfce</a>,    <a href="./tag/backup.html">backup</a>,    <a href="./tag/proxy.html">Proxy</a>,    <a href="./tag/pelican.html">pelican</a>,    <a href="./tag/markdown.html">markdown</a>,    <a href="./tag/firewall.html">FireWall</a>,    <a href="./tag/ghettovcb.html">ghettoVCB</a>,    <a href="./tag/sol.html">sol</a>,    <a href="./tag/socks.html">Socks</a>,    <a href="./tag/down.html">down</a>,    <a href="./tag/big-brother.html">big-brother</a>,    <a href="./tag/exploit.html">exploit</a>,    <a href="./tag/api.html">api</a>,    <a href="./tag/linux.html">linux</a>,    <a href="./tag/curlftpfs.html">curlftpfs</a>,    <a href="./tag/snmpd.html">SNMPd</a>,    <a href="./tag/cloud.html">cloud</a>,    <a href="./tag/tracepath.html">tracepath</a>,    <a href="./tag/code.html">code</a>,    <a href="./tag/git.html">git</a>,    <a href="./tag/cgroups.html">cgroups</a>,    <a href="./tag/tuning.html">Tuning</a>,    <a href="./tag/octopress.html">octopress</a>,    <a href="./tag/snmp.html">SNMP</a>,    <a href="./tag/debian.html">debian</a>,    <a href="./tag/wordpress.html">wordpress</a>,    <a href="./tag/dns.html">dns</a>,    <a href="./tag/forward.html">forward</a>,    <a href="./tag/tcpdump.html">tcpdump</a>,    <a href="./tag/big-data.html">big data</a>,    <a href="./tag/openvz.html">openvz</a>,    <a href="./tag/asymmetric.html">asymmetric</a>,    <a href="./tag/openvpn.html">openvpn</a>,    <a href="./tag/redmon.html">redmon</a>,    <a href="./tag/benchmark.html">benchmark</a>,    <a href="./tag/nc.html">nc</a>,    <a href="./tag/blacklist.html">blacklist</a>,    <a href="./tag/collectd.html">collectd</a>,    <a href="./tag/mail.html">Mail</a>,    <a href="./tag/oauth.html">oauth</a>,    <a href="./tag/vpn.html">vpn</a>,    <a href="./tag/bug.html">bug</a>,    <a href="./tag/iscsi.html">iSCSI</a>,    <a href="./tag/oauth2.html">oauth2</a>,    <a href="./tag/itil.html">itil</a>,    <a href="./tag/cluster.html">cluster</a>,    <a href="./tag/tunnel.html">Tunnel</a>,    <a href="./tag/esxi.html">ESXi</a>,    <a href="./tag/lumberjack.html">lumberjack</a>,    <a href="./tag/tcp_tw_recycle.html">tcp_tw_recycle</a>,    <a href="./tag/bucket.html">bucket</a>,    <a href="./tag/hosting.html">hosting</a>,    <a href="./tag/screenos.html">ScreenOS</a>,    <a href="./tag/control-panel.html">control panel</a>,    <a href="./tag/iozone.html">iozone</a>,    <a href="./tag/ui.html">ui</a>,    <a href="./tag/roundcube.html">Roundcube</a>,    <a href="./tag/error.html">error</a>,    <a href="./tag/lvm.html">lvm</a>,    <a href="./tag/sysbench.html">sysbench</a>,    <a href="./tag/scripting.html">scripting</a>,    <a href="./tag/san.html">SAN</a>,    <a href="./tag/bind.html">bind</a>,    <a href="./tag/syscall.html">syscall</a>,    <a href="./tag/pop3s.html">POP3S</a>,    <a href="./tag/squid.html">Squid</a>,    <a href="./tag/smtp.html">SMTP</a>,    <a href="./tag/vm.html">VM</a>,    <a href="./tag/hardware.html">Hardware</a>,    <a href="./tag/raw.html">raw</a>,    <a href="./tag/fail2ban.html">fail2ban</a>,    <a href="./tag/conntrack.html">conntrack</a>,    <a href="./tag/vestacp.html">vestacp</a>,    <a href="./tag/curl.html">curl</a>,    <a href="./tag/paws.html">paws</a>,    <a href="./tag/7z.html">7z</a>,    <a href="./tag/gcc.html">gcc</a>,    <a href="./tag/recover.html">recover</a>,    <a href="./tag/monitoring.html">monitoring</a>,    <a href="./tag/relay.html">relay</a>,    <a href="./tag/authoritative.html">authoritative</a>,    <a href="./tag/mod-fastcgi.html">mod-fastcgi</a>,    <a href="./tag/php-fpm.html">php-fpm</a>,    <a href="./tag/storage.html">storage</a>,    <a href="./tag/high-availability.html">High Availability</a>,    <a href="./tag/dkim.html">DKIM</a>,    <a href="./tag/junos.html">JunOS</a>,    <a href="./tag/df.html">df</a>,    <a href="./tag/github-pages.html">github pages</a>,    <a href="./tag/gre.html">GRE</a>,    <a href="./tag/dyndns.html">dyndns</a>,    <a href="./tag/openwrt.html">openwrt</a>,    <a href="./tag/performance.html">performance</a>,    <a href="./tag/channel.html">channel</a>,    <a href="./tag/raid.html">RAID</a>,    <a href="./tag/users.html">users</a>,    <a href="./tag/raspberry-pi.html">Raspberry Pi</a>,    <a href="./tag/filtering.html">Filtering</a>,    <a href="./tag/mongodb.html">mongodb</a>,    <a href="./tag/aws.html">AWS</a>,    <a href="./tag/vcb.html">VCB</a>,    <a href="./tag/metrics.html">metrics</a>,    <a href="./tag/reverse-shell.html">reverse shell</a>,    <a href="./tag/stripe.html">stripe</a>,    <a href="./tag/drac.html">drac</a>,    <a href="./tag/sshfs.html">sshfs</a>,    <a href="./tag/php.html">PHP</a>,    <a href="./tag/payment.html">payment</a>,    <a href="./tag/pflogsumm.html">pflogsumm</a>,    <a href="./tag/pop3.html">POP3</a>,    <a href="./tag/ip-accounting.html">IP Accounting</a>,    <a href="./tag/remote.html">remote</a>,    <a href="./tag/replication.html">Replication</a>,    <a href="./tag/mobile.html">mobile</a>,    <a href="./tag/isg.html">ISG</a>,    <a href="./tag/monit.html">Monit</a>,    <a href="./tag/snapshot.html">snapshot</a>,    <a href="./tag/filesystem.html">filesystem</a>,    <a href="./tag/dos.html">DoS</a>,    <a href="./tag/incron.html">incron</a>,    <a href="./tag/cpu.html">cpu</a>,    <a href="./tag/predis.html">predis</a>  </section>



</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2011&ndash;2016  JoKeru &mdash;
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
  <script src="./theme/js/modernizr-2.0.js"></script>
  <script src="./theme/js/ender.js"></script>
  <script src="./theme/js/octopress.js" type="text/javascript"></script>
</body>
</html>